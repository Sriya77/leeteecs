<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    background-color: #1a120b; 
    color: #a5a394; 
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    flex-direction: column;
    padding: 20px;
  }
  .input-container {
    margin: 20px;
    text-align: center;
  }
  .input-container input,
  .input-container button {
    padding: 10px;
    font-size: 1rem;
    border-radius: 5px;
    border: none;
  }
  .input-container input {
    width: 250px;
    margin-right: 10px;
  }
  .input-container button {
    background-color: #fff0dc; 
    color: #131010;
    cursor: pointer;
  }
  .input-container button:hover {
    background-color: #e6d7b9; 
  }
  .stats-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); 
    gap: 30px;
    margin-top: 40px;
    width: 100%;
    max-width: 1200px; 
  }
  .glassmorphism {
    background: #573d30;
    border-radius: 15px;
    padding: 20px;
    backdrop-filter: blur(10px);
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-align: center;
  }
  .glassmorphism h3 {
    margin: 0;
    font-size: 1.2rem;
    flex: 1;
  }
  .spinner {
    border: 8px solid rgba(76, 75, 75, 0.1);
    border-top: 8px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  #loadingSpinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 50;
    visibility: hidden;
  }
  #loadingSpinner.visible {
    visibility: visible;
  }
  #userStats {
    margin-top: 20px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  canvas {
    width: 100px !important;
    height: 100px !important;
  }

  /* Responsive Styles */
  @media (max-width: 1024px) {
    .stats-container {
      grid-template-columns: repeat(
        2,
        1fr
      ); 
    }
  }

  @media (max-width: 768px) {
    .stats-container {
      grid-template-columns: 1fr;
    }
    canvas {
      width: 80px !important;
      height: 80px !important; 
    }
  }
  .horizontal-row {
    display: flex;
    flex-wrap: nowrap; 
    overflow-x: auto; 
    gap: 20px; 
  }

  .month-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .month-label {
    font-size: 14px;
    font-weight: bold;
    color: #a5a394;
    margin-bottom: 5px;
  }

  .grid-container {
    display: flex;
    gap: 5px;
  }

  .week {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .contribution-cell {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }
  .us22 {
background-color: transparent;
border: 2px solid #a5a394;
padding: 2%;
border-radius: 15px;
color: #e6e2dd;
max-width: 100%; /* Ensures the element doesn't exceed container width */
box-sizing: border-box; /* Ensures padding doesn't affect width */
}

/* For screens smaller than 1024px (tablets and below) */
@media (max-width: 1024px) {
.us22 {
padding: 3%; /* Increase padding slightly for tablets */
}
}

/* For screens smaller than 768px (phones and below) */
@media (max-width: 768px) {
.us22 {
padding: 4%; /* Further increase padding for smaller devices */
font-size: 14px; /* Adjust font size for smaller screens */
}
}

</style>
</head>
<body>
<h1>LEETCODE USER-STATS</h1>
<div class="input-container">
  <input type="text" id="username" placeholder="Enter Username" />
  <button onclick="fetchuserstats()">Okay</button>
</div>
<div id="loadingSpinner">
  <div class="spinner"></div>
</div>

<!-- Container to display user stats -->
<div id="userStats"></div>
<div id="us2"></div>

<div id="heatmapChart"></div>

<script>
  async function fetchuserstats() {
    const username = document.getElementById("username").value;

    // Show loading spinner
    document.getElementById("loadingSpinner").classList.add("visible");

    

    try {
      const response = await fetch(`http://localhost:3000/${username}`);
      const data = await response.json();
      console.log("hi", data);
      var ss = data.data.data.matchedUser == "null";
      console.log(ss);
      if(data.data.data.matchedUser == null){
          console.log("heelluwwww")
          document.getElementById("us2").innerHTML =
          '<div class = "us22"><h1>NO USER EXISTS!</h1></div>';
          return;
        }
      if (data.errors && data.errors.length > 0) {
        if (
          data.errors.some((error) =>
            error.message.includes("user does not exist")
          )
        ) {
          throw new error("BlahBlah")
        } else {
          throw new Error("An error occurred while fetching user data");
        }
      }

      // If no errors, proceed with displaying the data
      displayUserStats(data);
      createHeatmap(data.submissionCalendar);
    } catch (error) {
      console.log(error);
    } finally {
      // Hide loading spinner
      document.getElementById("loadingSpinner").classList.remove("visible");
    }
  }

  function displayUserStats(data) {
    const statsHtml = `
      <div class="stats-container">
        <div class="glassmorphism">
          <h3>Total Solved:</h3>
          <canvas id="totalSolvedChart"></canvas>
          <p>${data.totalSolved} / ${data.totalQuestions}</p>
        </div>
        <div class="glassmorphism">
          <h3>Ranking:</h3>
          <p>${data.ranking}</p>
        </div>
        <div class="glassmorphism">
          <h3>Contribution Points:</h3>
          <p>${data.contributionPoints}</p>
        </div>
        <div class="glassmorphism">
          <h3>Easy Solved:</h3>
          <canvas id="easySolvedChart"></canvas>
          <p>${data.easySolved} / ${data.totalEasy}</p>
        </div>
        <div class="glassmorphism">
          <h3>Medium Solved:</h3>
          <canvas id="mediumSolvedChart"></canvas>
          <p>${data.mediumSolved} / ${data.totalMedium}</p>
        </div>
        <div class="glassmorphism">
          <h3>Hard Solved:</h3>
          <canvas id="hardSolvedChart"></canvas>
          <p>${data.hardSolved} / ${data.totalHard}</p>
        </div>
      </div>
    `;

    // Render the stats in the `userStats` container
    document.getElementById("userStats").innerHTML = statsHtml;

    // Create the donut chart for Total Solved
    createDonutChart(
      "totalSolvedChart",
      "Total Solved",
      data.totalSolved,
      data.totalQuestions
    );

    // Create the donut chart for Easy Solved
    createDonutChart(
      "easySolvedChart",
      "Easy Solved",
      data.easySolved,
      data.totalEasy
    );

    // Create the donut chart for Medium Solved
    createDonutChart(
      "mediumSolvedChart",
      "Medium Solved",
      data.mediumSolved,
      data.totalMedium
    );

    // Create the donut chart for Hard Solved
    createDonutChart(
      "hardSolvedChart",
      "Hard Solved",
      data.hardSolved,
      data.totalHard
    );
  }

  function createDonutChart(elementId, label, solved, total) {
    const ctx = document.getElementById(elementId).getContext("2d");
    const percentage = (solved / total) * 100;
    const isSolved = solved > 0;
    const donutColor = isSolved
      ? percentage > 75
        ? "#66bb6a"
        : percentage > 50
        ? "#ffeb3b"
        : "#9EDF9C"
      : "transparent";

    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: [label],
        datasets: [
          {
            data: [solved, total - solved], // Solved vs remaining problems
            backgroundColor: [donutColor, "#cccccc"], // Color based on solved percentage
            borderColor: [donutColor, "#666666"],
            borderWidth: 2, // Thinner donut
          },
        ],
      },
      options: {
        responsive: true,
        cutoutPercentage: 80, // Make the chart thinner
        aspectRatio: 1, // Keep the chart circular (or slightly rectangular)
        plugins: {
          legend: {
            display: false, // Hiding the legend since we are only showing one part
          },
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                const value = tooltipItem.raw;
                return `${label}: ${value}`;
              },
            },
          },
        },
      },
    });
  }
  document.getElementById("username").addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        fetchuserstats();
      }
  });

  function createHeatmap(submissionCalendar) {
const heatmapContainer = document.getElementById("heatmapChart");
heatmapContainer.className = "heatmap-title";
heatmapContainer.innerHTML =
'<h2>Submission Heatmap</h2>'; // Clear existing content

// Add internal styles
const style = document.createElement("style");
style.textContent = `
.heatmap-title{
align-item:center;
}
.heatmap-container {
display: flex;
flex-direction: column;
gap: 2rem;
font-family: Arial, sans-serif;
border: 2px solid #a5a394;
border-radius: 15px;
padding: 20px;
background: #573d30;
box-sizing: border-box;
backdrop-filter: blur(10px);
}

.heatmap-container h2 {
text-align: center;
color: #a5a394;
}

.months-container {
display: flex;
font-size: 0.75rem;
color: #a5a394;
margin-bottom: 0.5rem;
}

.month-label {
flex: 1;
text-align: center;
font-weight: bold;
}

.grid-container {
display: flex;
flex-wrap: wrap;
gap: 1rem;
align-items: flex-start;
margin-top: 0.5rem;
}

.week-container {
display: flex;
flex-direction: row;
gap: 0.25rem;
}

.contribution-cell {
width: 12px;
height: 12px;
border-radius: 2px;
background-color: #ccc;
margin-bottom: 0.25rem;
transition: transform 0.3s ease;
}

.contribution-cell:hover {
transform: scale(1.2);
}

.level-0 {
background-color: #161b22;
}

.level-1 {
background-color: #0e4429;
}

.level-2 {
background-color: #006d32;
}

.level-3 {
background-color: #26a641;
}

.level-4 {
background-color: #39d353;
}

.legend-container {
display: flex;
flex-wrap: wrap;
gap: 0.5rem;
font-size: 0.75rem;
color: #a5a394;
margin-top: 1rem;
}

.legend-cell {
width: 20px;
height: 20px;
margin-right: 0.25rem;
}

/* Responsive Styles */
@media (max-width: 1024px) {
.heatmap-container {
padding: 15px;
}
}

@media (max-width: 768px) {
.heatmap-container {
padding: 10px;
}
}

`;
document.head.appendChild(style);

// Create container for the entire heatmap
const container = document.createElement("div");
container.className = "heatmap-container";

// Create month labels
const monthsContainer = document.createElement("div");
monthsContainer.className = "months-container";
const months = [
"Jan",
"Feb",
"Mar",
"Apr",
"May",
"Jun",
"Jul",
"Aug",
"Sep",
"Oct",
"Nov",
"Dec",
];
months.forEach((month) => {
const monthLabel = document.createElement("div");
monthLabel.className = "month-label";
monthLabel.textContent = month;
monthsContainer.appendChild(monthLabel);
});
container.appendChild(monthsContainer);

// Create grid container
const gridContainer = document.createElement("div");
gridContainer.className = "grid-container";

// Add day labels (Mon, Wed, Fri)
// const dayLabels = document.createElement("div");
// dayLabels.className = "day-labels";
// ["Mon", "Wed", "Fri"].forEach((day) => {
//   const dayLabel = document.createElement("div");
//   dayLabel.textContent = day;
//   dayLabels.appendChild(dayLabel);
// });
// gridContainer.appendChild(dayLabels);

// Process and create contribution grid
const { weeks } = processCalendarData(submissionCalendar);
weeks.forEach((week) => {
const weekContainer = document.createElement("div");
weekContainer.className = "week-container";
week.forEach(({ date, count }) => {
  const cell = document.createElement("div");
  cell.className = `contribution-cell level-${getContributionLevel(count)}`;
  cell.title = `${date}: ${count} submissions`;
  weekContainer.appendChild(cell);
});
gridContainer.appendChild(weekContainer);
});

container.appendChild(gridContainer);

// Add legend


heatmapContainer.appendChild(container);
}

function processCalendarData(submissionCalendar) {
const weeks = [];
let currentWeek = [];

// Convert timestamps to date objects and sort them
const dates = Object.keys(submissionCalendar)
.map((timestamp) => ({
  date: new Date(timestamp * 1000),
  count: submissionCalendar[timestamp],
}))
.sort((a, b) => a.date - b.date);

// Fill in missing dates with zero contributions
const startDate = dates[0].date;
const endDate = dates[dates.length - 1].date;
const dateMap = new Map(
dates.map((d) => [d.date.toISOString().split("T")[0], d.count])
);

for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
const dateStr = d.toISOString().split("T")[0];
const count = dateMap.get(dateStr) || 0;
const dayOfWeek = d.getDay();

if (dayOfWeek === 0 && currentWeek.length > 0) {
  weeks.push(currentWeek);
  currentWeek = [];
}

currentWeek.push({
  date: dateStr,
  count: count,
});

if (currentWeek.length === 7) {
  weeks.push(currentWeek);
  currentWeek = [];
}
}

if (currentWeek.length > 0) {
weeks.push(currentWeek);
}

return { weeks };
}

function getContributionLevel(count) {
if (count === 0) return 0;
if (count <= 3) return 1;
if (count <= 6) return 2;
if (count <= 9) return 3;
return 4;
}


</script>
</body>
</html>
